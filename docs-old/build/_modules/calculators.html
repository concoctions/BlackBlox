

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>calculators &mdash; blackblox.py 0.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo150.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                blackblox v0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">NOTE: This introductory document still must be updated with the latest feature set</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro.html#what-is-blackblox-py">What is blackblox.py?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unit.html">The Unit Process Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chain.html">The Process Chain Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../factory.html">The Factory Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../industry.html">The Industry Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../calculators.html">The Calculators Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../io_functions.html">The IO Functions Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataconfig.html">The dataconfig Module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">blackblox.py</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>calculators</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for calculators</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; Calculator functions used in balancing unit processes</span>

<span class="sd">This module contains the standard set of functions used to manipulate the </span>
<span class="sd">quantites specified in the user data. The calculation type specified by the </span>
<span class="sd">user must be of one of the type specified here, or one defined by the user in</span>
<span class="sd">custom_lookup.py</span>

<span class="sd">The &quot;invert&quot; option throughout the calculation helps the unit processes to </span>
<span class="sd">balance processes balance on an arbitrary known quantity even though</span>
<span class="sd">the user is specifying only a single-directional relationship between substance</span>
<span class="sd">quantities in the relationships table.</span>

<span class="sd">Note, the use of \*\*kwargs in the function argument calls is required to </span>
<span class="sd">allow the functions to work properly, since all possible calculatr variables  </span>
<span class="sd">are provided to the calculator function in unitprocess.py, whether or</span>
<span class="sd">not they are used by that specific function.</span>

<span class="sd">Module Outline:</span>
<span class="sd">- imports and logger</span>
<span class="sd">- function: check_qty</span>
<span class="sd">- function: Ratio</span>
<span class="sd">- function: Remainder</span>
<span class="sd">- function: ReturnValue</span>
<span class="sd">- function: MolMassRatio</span>
<span class="sd">- function: check_balance</span>
<span class="sd">- module variable: calcs_dict</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">molmass</span> <span class="k">import</span> <span class="n">Formula</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">io_functions</span> <span class="k">as</span> <span class="nn">iof</span>
<span class="kn">import</span> <span class="nn">dataconfig</span> <span class="k">as</span> <span class="nn">dat</span>
<span class="kn">from</span> <span class="nn">bb_log</span> <span class="k">import</span> <span class="n">get_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;Calculators&quot;</span><span class="p">)</span>

<span class="c1"># LOOKUP DATA NEEDED BY CALCULATORS</span>
<span class="n">df_fuels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="s1">&#39;fuel&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">lookup_var_dict</span><span class="p">:</span>
    <span class="n">df_fuels</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">lookup_var_dict</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">][</span><span class="s1">&#39;filepath&#39;</span><span class="p">],</span> <span class="n">sheet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">lookup_var_dict</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">][</span><span class="s1">&#39;sheet&#39;</span><span class="p">])</span>

<span class="c1"># FUNCTIONS USED BY CALCUALTOR FUNCTIONS</span>
<div class="viewcode-block" id="check_qty"><a class="viewcode-back" href="../calculators.html#calculators.check_qty">[docs]</a><span class="k">def</span> <span class="nf">check_qty</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">fraction</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks that a quantity is &gt; 0 and optionally &lt; 1.</span>
<span class="sd">    Raises and error if the quantity is negative, and, optionally, if it is </span>
<span class="sd">    less than one. Currently BlackBlox does not support negative masses or</span>
<span class="sd">    energy contents. This isn&#39;t quantum.</span>

<span class="sd">    Args:</span>
<span class="sd">        qty (float or int): number to check</span>
<span class="sd">        fraction (bool): whether the number should be between 0 and 1</span>
<span class="sd">            (Defaults to False.)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;quantity should be &gt; 0. Currently: </span><span class="si">{qty}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fraction</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;quantity should be between 0 and 1. Currently: </span><span class="si">{qty}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="c1"># CALCULATION FUNCTIONS</span>
<div class="viewcode-block" id="Ratio"><a class="viewcode-back" href="../calculators.html#calculators.Ratio">[docs]</a><span class="k">def</span> <span class="nf">Ratio</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Multiplies or divides a quantity by a given ratio.</span>

<span class="sd">    This function exists as it is to allow unit processes to be calculated </span>
<span class="sd">    backwards or forwards. The user only has to specify one relationship</span>
<span class="sd">    (e.g. Y:X for a known X), but if it is Y that&#39;s known, then it flips</span>
<span class="sd">    the ratio to be X:Y.</span>

<span class="sd">    Examples:</span>
<span class="sd">            &gt;&gt;&gt; Ratio(5, 3)</span>
<span class="sd">            15</span>

<span class="sd">            &gt;&gt;&gt; Ratio(5, 3, invert=True)</span>
<span class="sd">            1.6666666666666665</span>

<span class="sd">    Args:</span>
<span class="sd">        qty: The known quantity</span>
<span class="sd">        var: The ratio of unknown:known quantities</span>
<span class="sd">        invert (Bool): Specigy True if the ratio is known:unknown. Converts the </span>
<span class="sd">            ratio to 1/ratio. </span>
<span class="sd">            (Default is False.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        The original quantity multipled by the ratio.</span>
<span class="sd">  </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting ratio calcuation using qty: </span><span class="si">{}</span><span class="s2">, ratio: </span><span class="si">{}</span><span class="s2">, invert: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">invert</span><span class="p">))</span>

    <span class="n">check_qty</span><span class="p">(</span><span class="n">qty</span><span class="p">)</span>
    <span class="n">check_qty</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">invert</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">var</span>

    <span class="k">return</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">var</span></div>


<div class="viewcode-block" id="Remainder"><a class="viewcode-back" href="../calculators.html#calculators.Remainder">[docs]</a><span class="k">def</span> <span class="nf">Remainder</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Multiplies a quantity by the inverse of a known ratio between 0 and 1</span>

<span class="sd">    The Remainder function is useful when both the known and unknown quantities</span>
<span class="sd">    are two parts of the same total, but the percentage balance may change </span>
<span class="sd">    (such as with efficiencies (product + loss will always equal 100%). </span>
<span class="sd">    The ratio of X:Y and Y:X should always equal 1.0.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; Remainder(5, 0.3)</span>
<span class="sd">        3.5</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; Remainder(5, 0.3, invert=True)</span>
<span class="sd">        7.142857142857143</span>

<span class="sd">    Args:</span>
<span class="sd">        qty: The known quantity</span>
<span class="sd">        var: The ratio of known:total quantities. A number between 0 and 1,</span>
<span class="sd">            where 1-var is the ratio of unknown:total.</span>
<span class="sd">        invert (bool): True if the ratio is unknown:total. Converts the ratio</span>
<span class="sd">            to 1/ratio. </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting remainder calcuation using qty: </span><span class="si">{}</span><span class="s2">, ratio: </span><span class="si">{}</span><span class="s2">, invert: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">invert</span><span class="p">))</span>

    <span class="n">check_qty</span><span class="p">(</span><span class="n">qty</span><span class="p">)</span>
    <span class="n">check_qty</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fraction</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">ratioRemaining</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">var</span>

    <span class="k">if</span> <span class="n">invert</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qty</span> <span class="o">/</span> <span class="n">ratioRemaining</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">ratioRemaining</span></div>


<div class="viewcode-block" id="ReturnValue"><a class="viewcode-back" href="../calculators.html#calculators.ReturnValue">[docs]</a><span class="k">def</span> <span class="nf">ReturnValue</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the value passed to it.</span>

<span class="sd">    Returns the value passed as the qty argument. Useful for creating temporary</span>
<span class="sd">    values with unique names in the unit process&#39;s temporary dictionary if</span>
<span class="sd">    substance of same name exists in both input and output dictionary.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; ReturnValue(5)</span>
<span class="sd">        5</span>

<span class="sd">    Args:</span>
<span class="sd">        qty: a quantity (or anything really)</span>

<span class="sd">    Returns:</span>
<span class="sd">        qty: literally the exact thing you gave it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">qty</span></div>


<div class="viewcode-block" id="MolMassRatio"><a class="viewcode-back" href="../calculators.html#calculators.MolMassRatio">[docs]</a><span class="k">def</span> <span class="nf">MolMassRatio</span><span class="p">(</span><span class="n">known_substance</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">unknown_substance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses the ratio of molecular mass of two substances to </span>
<span class="sd">    </span>
<span class="sd">    This function takes the quantity of a known substance and the name of </span>
<span class="sd">    that substance and another which are also valid chemical compositions </span>
<span class="sd">    and uses the ratio of their molecular weights to calculate the quantity </span>
<span class="sd">    of the substance of unknown quantity.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; MolMassRatio(&#39;CaCO3&#39;, 5, &#39;CO2&#39;)</span>
<span class="sd">        2.198564447495127</span>

<span class="sd">        &gt;&gt;&gt; MolMassRatio(&#39;C8H10N4O2&#39;, 5, &#39;C12H22O11&#39;)</span>
<span class="sd">        8.81341527344784</span>
<span class="sd">        </span>

<span class="sd">    Args:</span>
<span class="sd">        known_substance (str): The name of the substance of known quantity, </span>
<span class="sd">            which must be a valid chemical composition</span>
<span class="sd">        qty: The quantity of the known substance</span>
<span class="sd">     unknown_substance (str): The name of the substance of unknown quantity,</span>
<span class="sd">            which must be a valid chemical composition.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting mol mass ratio calcuation using </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">known_substance</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">unknown_substance</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">qty</span> <span class="o">*</span> <span class="p">(</span><span class="n">Formula</span><span class="p">(</span><span class="n">unknown_substance</span><span class="p">)</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="n">Formula</span><span class="p">(</span><span class="n">known_substance</span><span class="p">)</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subtraction"><a class="viewcode-back" href="../calculators.html#calculators.Subtraction">[docs]</a><span class="k">def</span> <span class="nf">Subtraction</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">qty2</span><span class="p">,</span> <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subtracts one quantity from another.</span>

<span class="sd">    Assuming the known values are X and X1, returns Y = X - X1.</span>
<span class="sd">    If invert is True, then assumes that the known values are Y and X1, and </span>
<span class="sd">    returns X = Y + X1</span>

<span class="sd">    Args:</span>
<span class="sd">        qty (float): The quantity of a known substance</span>
<span class="sd">        qty2 (float): The quantity of another known substance</span>
<span class="sd">        invert: If True, adds rathers the values rather than subtracts them.</span>
<span class="sd">            (Defaults to False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The quantity of a third substance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">invert</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qty</span> <span class="o">-</span> <span class="n">qty2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qty</span> <span class="o">+</span> <span class="n">qty2</span></div>

<div class="viewcode-block" id="Addition"><a class="viewcode-back" href="../calculators.html#calculators.Addition">[docs]</a><span class="k">def</span> <span class="nf">Addition</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">qty2</span><span class="p">,</span> <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds one quantity to another.</span>

<span class="sd">    Assuming the known values are X and X1, returns Y = X + X1.</span>
<span class="sd">    If invert is True, then assumes that the known values are Y and X1, and </span>
<span class="sd">    returns X = Y - X1</span>

<span class="sd">    Args:</span>
<span class="sd">        qty (float): The quantity of a known substance</span>
<span class="sd">        qty2 (float): The quantity of another known substance</span>
<span class="sd">        invert: If True, subtracts rathers the values rather than adds them.</span>
<span class="sd">            (Defaults to False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The quantity of a third substance</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">invert</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qty</span> <span class="o">+</span> <span class="n">qty2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">qty</span> <span class="o">-</span> <span class="n">qty2</span>    </div>



<div class="viewcode-block" id="check_balance"><a class="viewcode-back" href="../calculators.html#calculators.check_balance">[docs]</a><span class="k">def</span> <span class="nf">check_balance</span><span class="p">(</span><span class="n">inflow_dict</span><span class="p">,</span> <span class="n">outflow_dict</span><span class="p">,</span> <span class="n">raise_imbalance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                  <span class="n">ignore_flows</span><span class="o">=</span><span class="p">[],</span> <span class="n">only_these_flows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">round_n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks whether two dictionary mass values sum to equivelent quantities </span>

<span class="sd">    Used to check whether the inflows and outflows of a unit process are</span>
<span class="sd">    balanced. Takes dictionaries of inflows and outflows with substance names</span>
<span class="sd">    as keys and quantities as values. Optionally can use a list of substance name </span>
<span class="sd">    prefix/suffix tags to exclude flows (e.g. energy flows in a mass balance), or</span>
<span class="sd">    only include certain flows (e.g. only include those with the energy tag)</span>

<span class="sd">    Args:</span>
<span class="sd">        inflow_dict (dict/defaultdict): the dictionary of inflows with </span>
<span class="sd">            the format inflow_dict[substance name] = quantity</span>
<span class="sd">        outflow_dict (dict/defaultdict): the dictionary of outflows with</span>
<span class="sd">            the format outflow_dict[substance name] = quantity</span>
<span class="sd">        round_n (int): Number of places after the decimal to use when checking</span>
<span class="sd">            if inflow and outflow masses are equivelent.</span>
<span class="sd">            Defaults to 5.</span>
<span class="sd">        ignore_flows (list[str]): A list of strings that indicate that a </span>
<span class="sd">            substance is not be included in the balance. If any of the keys in </span>
<span class="sd">            he inflow_dict or outflow_dict begin or end with a string in the </span>
<span class="sd">            ignore_flows list, the substance will not be added to the total </span>
<span class="sd">            quantity.</span>
<span class="sd">            (Defaults to an empty list)</span>
<span class="sd">        only_these_flows (bool/list): if given a list of strings, will only</span>
<span class="sd">            include those flows that begin or end with the strings in this</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the mass flows are balanced. Otherwise False.</span>
<span class="sd">        float: sum of all mass inflows.</span>
<span class="sd">        float: sum of all mass outflows.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">totals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">flows</span> <span class="o">=</span> <span class="p">[[],[]]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flow_dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">inflow_dict</span><span class="p">,</span> <span class="n">outflow_dict</span><span class="p">]):</span>

        <span class="k">for</span> <span class="n">substance</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">flow_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">substance</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">substance</span><span class="p">)</span>
            <span class="n">ignore</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">only_these_flows</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">includable</span> <span class="ow">in</span> <span class="n">only_these_flows</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">substance</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">includable</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{substance}</span><span class="s1"> not includable; </span><span class="si">{qty}</span><span class="s1"> discarded from inflows&#39;</span><span class="p">)</span>
                        <span class="n">ignore</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">substance</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">includable</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{substance}</span><span class="s1"> not includable; </span><span class="si">{qty}</span><span class="s1"> discarded from inflows&#39;</span><span class="p">)</span>
                        <span class="n">ignore</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    
            <span class="k">for</span> <span class="n">ignorable</span> <span class="ow">in</span> <span class="n">ignore_flows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">substance</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ignorable</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{substance}</span><span class="s1"> ignorable; </span><span class="si">{qty}</span><span class="s1"> discarded from inflows&#39;</span><span class="p">)</span>
                    <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">substance</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ignorable</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{substance}</span><span class="s1"> ignorable; </span><span class="si">{qty}</span><span class="s1"> discarded from inflows&#39;</span><span class="p">)</span>
                    <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">totals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">qty</span>
                <span class="n">flows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">substance</span><span class="p">)</span>



    <span class="n">total_in</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">totals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">round_n</span><span class="p">)</span>
    <span class="n">total_out</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">totals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">round_n</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">raise_imbalance</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">total_in</span> <span class="o">!=</span> <span class="n">total_out</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;IMBALANCED! Total In:  </span><span class="si">{total_in}</span><span class="s1"> v Total Out: </span><span class="si">{total_out}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Total Inflow Mass:  </span><span class="si">{totals[0]}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Total Outflow Mass: </span><span class="si">{totals[1]}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Inflows:  </span><span class="si">{flows[0]}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Outflows: </span><span class="si">{flows[1]}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">total_in</span><span class="p">,</span> <span class="n">total_out</span></div>


<div class="viewcode-block" id="Combustion"><a class="viewcode-back" href="../calculators.html#calculators.Combustion">[docs]</a><span class="k">def</span> <span class="nf">Combustion</span><span class="p">(</span><span class="n">known_substance</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">unknown_substance</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> 
               <span class="n">emissions_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inflows_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
               <span class="n">emissions_list</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">default_emissions</span><span class="p">,</span> <span class="n">fuels_df</span><span class="o">=</span><span class="n">df_fuels</span><span class="p">,</span> 
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates fuel or energy quantity and combustion emissions</span>

<span class="sd">    This is a function designed to calculate the quantity of fuel </span>
<span class="sd">    necessary to generate a certain quantity of energy, or the quantity</span>
<span class="sd">    of energy generated by combusting a given quantity of fuel. It requires</span>
<span class="sd">    the existence of a dataframe with the HHV of the given fuel. </span>

<span class="sd">    It can also calculate the emission of combustion, if relevent factors are</span>
<span class="sd">    present in the fuel dataframe, and output that data to a outflows dictionary </span>
<span class="sd">    (e.g that of the unit process calling the function). </span>

<span class="sd">    Note:</span>
<span class="sd">    Besides the listed emissions, it will also calculate &quot;waste heat&quot; based on </span>
<span class="sd">    the combustion efficiency. </span>

<span class="sd">    To maintain mass balances, the difference between the combustion emissions</span>
<span class="sd">    and the fuel mass is added to the inflows dictionary (if specified) as </span>
<span class="sd">    &#39;O2&#39; (oxygen). To calculate non-oxygen-based combustion emissions and</span>
<span class="sd">    co-inflows, instead use the &quot;stoichiometric_combustion&quot; function, which</span>
<span class="sd">    requires the elemental composition of the fuel.</span>
<span class="sd">    </span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; Combustion(&#39;charcoal&#39;, 3, &#39;heat&#39;, 0.8)</span>
<span class="sd">        72.0</span>

<span class="sd">        &gt;&gt;&gt; Combustion(&#39;heat&#39;, 3, &#39;charcoal&#39;, 0.8)</span>
<span class="sd">        0.125</span>
<span class="sd"> </span>
<span class="sd">    Args:</span>
<span class="sd">        known_substance (str): The name of the known substance, either a solid</span>
<span class="sd">            fuel or an energy flow. If the string is not in the index of the </span>
<span class="sd">            fuels dataframe, known_substance is assumed to be the energy</span>
<span class="sd">            output of the combusted fuel.</span>
<span class="sd">        qty (float): the quantity of the known substance (mass or energy)</span>
<span class="sd">        unknown_substance (str): The name of the unknown substance, either a </span>
<span class="sd">            solid fuel or an energy flow. If the string is not in the index of </span>
<span class="sd">            the fuels dataframe, known_substance is assumed to be the energy</span>
<span class="sd">            output of the combusted fuel.</span>
<span class="sd">        var (float): the efficiency of combustion (Between 0 and 1).</span>
<span class="sd">        emissions_dict (defaultdict/bool): The destination dictionary where to </span>
<span class="sd">            store the calculated combustions emissions data. If no dictionary</span>
<span class="sd">            is provided, emission data will not be stored.</span>
<span class="sd">            (Defaults to False)</span>
<span class="sd">        inflows_dict (defaultdict/bool): The destination dictionary where to</span>
<span class="sd">            store the calculated combustion co-inputs data. If no dictionary</span>
<span class="sd">            is provided, co-inputs data will not be stored. Currently the only</span>
<span class="sd">            co-input considered is oxygen.</span>
<span class="sd">            (Defaults to False)</span>
<span class="sd">        emissions_list (list[str]): List of emissions to calculate, if emission</span>
<span class="sd">            factors are available in the fuel dataframe</span>
<span class="sd">            (Defaults to default_emission_list, defined above.)</span>
<span class="sd">        fuels_df (dataframe): The dataframe containing the names, HHVs,</span>
<span class="sd">            and emissions data of the fuel.</span>
<span class="sd">            (Defaults to df_fuels)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        float: The quantity of the unkown substance (fuel or energy)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting combustion calcuation for </span><span class="si">{}</span><span class="s2"> using qty </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> and efficiency of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unknown_substance</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">known_substance</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">known_substance</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">index</span> 
        <span class="ow">and</span> <span class="n">unknown_substance</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Neither </span><span class="si">{}</span><span class="s2"> nor </span><span class="si">{}</span><span class="s2"> is a known_substance fuel type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">known_substance</span><span class="p">,</span> <span class="n">unknown_substance</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">known_substance</span> <span class="ow">in</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">index</span> 
        <span class="ow">and</span> <span class="n">unknown_substance</span> <span class="ow">in</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Both </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> are known_substance fuel types.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">known_substance</span><span class="p">,</span> <span class="n">unknown_substance</span><span class="p">))</span>

    
    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">combust_eff</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;quantity should be between 0 and 1. Currently: </span><span class="si">{qty}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">combust_eff</span> <span class="o">=</span> <span class="n">var</span>

    <span class="k">if</span> <span class="n">known_substance</span> <span class="ow">in</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">fuel_type</span> <span class="o">=</span> <span class="n">known_substance</span>
        <span class="n">fuel_qty</span> <span class="o">=</span> <span class="n">qty</span>
        <span class="n">energy_qty</span> <span class="o">=</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">fuel_type</span><span class="p">,</span> <span class="s1">&#39;HHV&#39;</span><span class="p">]</span> <span class="c1"># total energy in fuel</span>
        <span class="n">return_qty</span> <span class="o">=</span> <span class="n">energy_qty</span> <span class="o">*</span> <span class="n">combust_eff</span> <span class="c1"># useful energy after combustion</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fuel_type</span> <span class="o">=</span> <span class="n">unknown_substance</span>
        <span class="n">energy_qty</span> <span class="o">=</span> <span class="n">qty</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">combust_eff</span><span class="p">)</span> <span class="c1"># total energy in fuel</span>
        <span class="n">fuel_qty</span> <span class="o">=</span> <span class="n">energy_qty</span> <span class="o">/</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">fuel_type</span><span class="p">,</span> <span class="s1">&#39;HHV&#39;</span><span class="p">]</span>
        <span class="n">return_qty</span> <span class="o">=</span> <span class="n">fuel_qty</span>

    <span class="n">combustion_emissions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">emissions_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">fuels_df</span><span class="p">:</span>
            <span class="n">combustion_emissions</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span> <span class="o">=</span> <span class="n">fuels_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">fuel_type</span><span class="p">,</span> <span class="n">emission</span><span class="p">]</span> <span class="o">*</span> <span class="n">fuel_qty</span>
    <span class="n">waste_heat</span> <span class="o">=</span> <span class="n">energy_qty</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">combust_eff</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">emissions_dict</span><span class="p">)</span> <span class="o">==</span> <span class="n">defaultdict</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">inflows_dict</span><span class="p">)</span> <span class="o">==</span> <span class="n">defaultdict</span><span class="p">:</span>
            <span class="n">inflows_dict</span><span class="p">[</span><span class="s1">&#39;O2&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">combustion_emissions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">-</span> <span class="n">fuel_qty</span> <span class="c1"># closes mass balance</span>
            <span class="n">inflows_dict</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;energy in </span><span class="si">{fuel_type}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_qty</span>
        <span class="n">emissions_dict</span><span class="p">[</span><span class="s1">&#39;waste heat&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">waste_heat</span>
        <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">combustion_emissions</span><span class="p">:</span>
            <span class="n">emissions_dict</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span> <span class="o">+=</span> <span class="n">combustion_emissions</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span>

        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Emission Data discarded:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">combustion_emissions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{emission}</span><span class="s2">: </span><span class="si">{combustion_emissions[emission]}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;waste_heat: </span><span class="si">{waste_heat}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">return_qty</span></div>


<span class="c1">#Calculation Type lookup dictionary</span>
<span class="n">calcs_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">Ratio</span><span class="p">,</span>
    <span class="s1">&#39;remainder&#39;</span><span class="p">:</span> <span class="n">Remainder</span><span class="p">,</span>
    <span class="s1">&#39;molmassratio&#39;</span><span class="p">:</span> <span class="n">MolMassRatio</span><span class="p">,</span>
    <span class="s1">&#39;returnvalue&#39;</span><span class="p">:</span> <span class="n">ReturnValue</span><span class="p">,</span>
    <span class="s1">&#39;subtraction&#39;</span><span class="p">:</span> <span class="n">Subtraction</span><span class="p">,</span>
    <span class="s1">&#39;addition&#39;</span><span class="p">:</span> <span class="n">Addition</span><span class="p">,</span>
    <span class="s1">&#39;combustion&#39;</span><span class="p">:</span> <span class="n">Combustion</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Dictionary of calculators available to process unit process relationships.</span>
<span class="sd">Must be manually updated if additional calculators are added to this module. </span>
<span class="sd">Automatically pulls in calculators in the custom_lookup module, if they are</span>
<span class="sd">specified in the custom_calcs_dict in that module.</span>

<span class="sd">Used by the Unit Process class&#39;s balance function.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">twoQty_calc_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subtraction&#39;</span><span class="p">,</span> <span class="s1">&#39;addition&#39;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;List of calculations that require two quantities to exist in the unit process flow dictionary.</span>

<span class="sd">Used by the Unit Process class&#39;s balance function.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, S.E. Tanzer

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>