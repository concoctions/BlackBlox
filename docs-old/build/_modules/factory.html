

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>factory &mdash; blackblox.py 0.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo150.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                blackblox v0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">NOTE: This introductory document still must be updated with the latest feature set</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro.html#what-is-blackblox-py">What is blackblox.py?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unit.html">The Unit Process Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chain.html">The Process Chain Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../factory.html">The Factory Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../industry.html">The Industry Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../calculators.html">The Calculators Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../io_functions.html">The IO Functions Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataconfig.html">The dataconfig Module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">blackblox.py</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>factory</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for factory</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; Factory class</span>

<span class="sd">This module contains the Factory class, which are objects that </span>
<span class="sd">link together (and can generate) a set of product chains. One product chain</span>
<span class="sd">produces the primary product(s) of the factory, whereas other auxillary chains</span>
<span class="sd">provide inflows or processes outflows from the main chain or other auxillary</span>
<span class="sd">chains. Auxillary chains can be attached to any process in any chain in the</span>
<span class="sd">factory.</span>

<span class="sd">Module Outline:</span>

<span class="sd">- import statements and logger</span>
<span class="sd">- class: Factory</span>
<span class="sd">    - class function: Build</span>
<span class="sd">    - class function: Balance</span>
<span class="sd">    - class function: Diagram</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pan</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">isnan</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">graphviz</span> <span class="k">import</span> <span class="n">Digraph</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">bb_log</span> <span class="k">import</span> <span class="n">get_logger</span>
<span class="kn">import</span> <span class="nn">io_functions</span> <span class="k">as</span> <span class="nn">iof</span>
<span class="kn">import</span> <span class="nn">dataconfig</span> <span class="k">as</span> <span class="nn">dat</span>
<span class="kn">import</span> <span class="nn">unitprocess</span> <span class="k">as</span> <span class="nn">unit</span>
<span class="kn">import</span> <span class="nn">processchain</span> <span class="k">as</span> <span class="nn">cha</span>
<span class="kn">import</span> <span class="nn">calculators</span> <span class="k">as</span> <span class="nn">calc</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;Factory&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Factory"><a class="viewcode-back" href="../factory.html#factory.Factory">[docs]</a><span class="k">class</span> <span class="nc">Factory</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Factories are sets of one or more connected products chains</span>

<span class="sd">    Factories have a primary product chain, and are balanced on a specific</span>
<span class="sd">    outflow of that chain. Auxillary chains link to the main chain (or other</span>
<span class="sd">    auxillary chains) at any or multiple unit processes in the chain, and </span>
<span class="sd">    balance on a specified inflow or outflow of that unit process(es), i.e.</span>
<span class="sd">    it is assumed the auxillary chain is either providing the inflow or</span>
<span class="sd">    accepting the outflow.</span>

<span class="sd">    Factories balance on a specified output product. Product chains that </span>
<span class="sd">    are not the main output product balance on the relevent inputs and </span>
<span class="sd">    outputs of the main product. All product chains in a factory are run </span>
<span class="sd">    using variables from the same scenario.</span>

<span class="sd">    Note:</span>
<span class="sd">        The product chain (main chain) is assumed to be the first chain</span>
<span class="sd">        in the tabular data listing the chains in the factory.</span>

<span class="sd">    Args:</span>
<span class="sd">        chains_file (DataFrame/str): Dataframe or filepath to tabular data</span>
<span class="sd">            detailing the process chains in the factory. The chain in the first</span>
<span class="sd">            row of data is assumed to be the main product flow.</span>
<span class="sd">            Must contain columns for:</span>
<span class="sd">            [Chain Name, Chain Product, Product_IO, ChainFile]</span>
<span class="sd">        connections_file (DataFrame/str): Dataframe or filepath to tabular data </span>
<span class="sd">            detailing the connections between the chains in the factory. </span>
<span class="sd">            Must contain columns for:</span>
<span class="sd">            [OriginChain, OriginProcess, Product, Product_IO_of_Origin, </span>
<span class="sd">            Product_IO_of_Destination, DestinationChain]    </span>
<span class="sd">        name (str, optional): The name of the factory. Defaults to False.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of the factory.</span>
<span class="sd">        chains_df (data frame): Tabular data of the factory chains and the</span>
<span class="sd">            location of their data.</span>
<span class="sd">        connections_df (data frame): Tabuloar data of the connections</span>
<span class="sd">            between the factory chains.</span>
<span class="sd">        main_chain (str): the name of the factory&#39;s product chain, taken from</span>
<span class="sd">            the first row of chains_df.</span>
<span class="sd">        main_product (str): the name of the factory&#39;s main product, taken from </span>
<span class="sd">            the first row of chains_df.</span>
<span class="sd">        chain_dict (dict): Dictionary of dictionaries containing process chain </span>
<span class="sd">            objects in the factory. Each chain name is an entry key, with a </span>
<span class="sd">            value of a dictionary containing the process chain object, name,</span>
<span class="sd">            product, and whether that product is a chain inflow or outflow.  </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain_list_file</span><span class="p">,</span> <span class="n">connections_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain_list_sheet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">connections_sheet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Factory&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chains_file</span> <span class="o">=</span> <span class="n">chain_list_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chains_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">chain_list_file</span><span class="p">,</span> <span class="n">chain_list_sheet</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">connections_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connections_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">chain_list_file</span><span class="p">,</span> <span class="n">connections_sheet</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connections_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">connections_file</span><span class="p">,</span> <span class="n">connections_sheet</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_chain</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_product</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Factory.build"><a class="viewcode-back" href="../factory.html#factory.Factory.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates the needed process chain objects for the factory</span>

<span class="sd">        Locates the data specified for each process chain, and generates</span>
<span class="sd">        objects for each chain. Populates self.main_chain, self.main_product,</span>
<span class="sd">        and self.chain_dict.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;initializing factory for </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">chain_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">chain_name</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_chain</span> <span class="o">=</span> <span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_product</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">chain_product</span><span class="p">]</span>
            
            <span class="n">chain_sheet</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">check_for_col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains_df</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">chain_sheetname</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">chain_filepath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains_df</span> 
                <span class="ow">or</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">chain_filepath</span><span class="p">])</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">same_xls</span><span class="p">):</span>
                <span class="n">chain_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chain_file</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">chain_filepath</span><span class="p">]</span>
                
            <span class="n">chain_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">chain</span><span class="o">=</span><span class="n">cha</span><span class="o">.</span><span class="n">ProductChain</span><span class="p">(</span><span class="n">chain_file</span><span class="p">,</span> 
                                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">xls_sheet</span><span class="o">=</span><span class="n">chain_sheet</span><span class="p">),</span> 
                                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> 
                                    <span class="n">product</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">chain_product</span><span class="p">],</span> 
                                    <span class="n">i_o</span><span class="o">=</span><span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">chain_io</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

            <span class="n">chain_dict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span> <span class="o">=</span> <span class="n">chain_dict</span></div>

<div class="viewcode-block" id="Factory.balance"><a class="viewcode-back" href="../factory.html#factory.Factory.balance">[docs]</a>    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_product_qty</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">default_scenario</span><span class="p">,</span> 
                <span class="n">write_to_xls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">mass_energy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">energy_flows</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">energy_flows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the mass balance of the factory</span>

<span class="sd">        Based on a quantity of the factory&#39;s main product, calculates the </span>
<span class="sd">        remaining quantities of all flows in the factory, assuming all unit </span>
<span class="sd">        processes are well-specified with zero degrees of freedom.</span>

<span class="sd">        Args:</span>
<span class="sd">            main_product_qty (float): the quantity of the product to balance on.</span>
<span class="sd">            product (str/bool): the product name. If False, uses the default</span>
<span class="sd">                product in the chain object attributes.</span>
<span class="sd">                (Defaults to False)</span>
<span class="sd">            scenario (str): The name of the scenario of variable values to use, </span>
<span class="sd">                corresponding to the matching row index in each unit process&#39;s</span>
<span class="sd">                var_df. </span>
<span class="sd">                (Defaults to the string specified in dat.default_scenario)</span>
<span class="sd">            write_to_xls (bool): If True, outputs the balances to an excel </span>
<span class="sd">                workbook, with sheets for factory totals, inflows and outflows</span>
<span class="sd">                for all unit processes, and inflows and outflows by chain.</span>
<span class="sd">                (Defaults to True)</span>
<span class="sd">            outdir (str): Filepath where to create the balance spreadsheets.</span>
<span class="sd">                (Defaults to the outdir specified in dataconfig)  </span>
<span class="sd">            mass_energy (bool): If true, seperates mass and energy flows within </span>
<span class="sd">                each excel sheet, adding rows for the respective totals.</span>
<span class="sd">                (Defaults to True)</span>
<span class="sd">            energy_flows (list): list of prefix/suffixes used to identify which </span>
<span class="sd">                substances are energy flows and seperates them.</span>
<span class="sd">                (Defaults to dat.energy_flows)</span>

<span class="sd">        Returns:</span>
<span class="sd">            dictionary of factory total inflow quantities by substance</span>
<span class="sd">            dictionary of factory total outflow quantities by substance</span>

<span class="sd">        &quot;&quot;&quot;</span>       
       
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">attempting to balance factory on </span><span class="si">{main_product_qty}</span><span class="s2"> of </span><span class="si">{self.chain_dict[self.main_chain][&#39;product&#39;]}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">io_dicts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">iof</span><span class="o">.</span><span class="n">nested_dicts</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="c1">#io_dicts[&#39;i&#39;][chain][unit][substance] = float</span>
            <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="n">iof</span><span class="o">.</span><span class="n">nested_dicts</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="c1">#io_dicts[&#39;o&#39;][chain][unit][substance] = float</span>
            <span class="p">}</span>
        <span class="n">chain_intermediates_dict</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">nested_dicts</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">intermediate_product_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1">#intra-factory flows (to be discarded from totals)</span>
        <span class="n">remaining_product_dict</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">nested_dicts</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="c1">#keeps track if a product has been used for recycle already dict[i_o][chain][unit][substance] = float</span>
        <span class="n">internal_flows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_chain</span><span class="p">]</span>
        
        <span class="c1"># balances main chain</span>
        <span class="p">(</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">main</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]],</span> 
        <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">main</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]],</span> 
        <span class="n">chain_intermediates_dict</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]],</span> 
        <span class="n">main_chain_internal_flows</span><span class="p">)</span> <span class="o">=</span> <span class="n">main</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">main_product_qty</span><span class="p">,</span> <span class="n">product</span><span class="o">=</span> <span class="n">main</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">],</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>

        <span class="n">internal_flows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">main_chain_internal_flows</span><span class="p">)</span>

        <span class="c1"># balances auxillary chains and recycle flows based on connections dataframe</span>
        <span class="k">for</span> <span class="n">dummy_index</span><span class="p">,</span> <span class="n">aux</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span> 
            <span class="n">qty</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">orig_unit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">orig_product_io</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_io</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">dest_product_io</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_io</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">connect_product</span><span class="p">]</span>
            <span class="n">dest_unit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">dest_unit_name</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">i_tmp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">o_tmp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">replace_flow</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">purge</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">qty_remaining</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_replace_fraction</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">replace_fuel</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">energy_replacing_fuel</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1">#gets origin and destination chain objects</span>
            <span class="n">orig_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_chain</span><span class="p">]][</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">io_dicts</span><span class="p">[</span><span class="n">orig_product_io</span><span class="p">][</span><span class="n">orig_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{io_dicts[orig_product_io][orig_chain.name]}</span><span class="s2"> has not been balanced yet. Please check the order of your connections in your connections dataframe.&quot;</span><span class="p">)</span>
            <span class="n">dest_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_chain</span><span class="p">]][</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">dest_unit</span> <span class="ow">in</span> <span class="n">aux</span><span class="p">:</span>
                 <span class="k">if</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_unit</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dest_chain</span><span class="o">.</span><span class="n">process_dict</span><span class="p">:</span>
                    <span class="n">dest_unit</span> <span class="o">=</span> <span class="n">dest_chain</span><span class="o">.</span><span class="n">process_dict</span><span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_unit</span><span class="p">]]</span>
                    <span class="n">dest_unit_name</span> <span class="o">=</span> <span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span>

            <span class="k">if</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_unit</span><span class="p">]</span> <span class="o">==</span> <span class="n">dat</span><span class="o">.</span><span class="n">connect_all</span><span class="p">:</span> <span class="c1">#if connects to all, use totals from chain</span>
                <span class="n">qty</span> <span class="o">=</span> <span class="n">io_dicts</span><span class="p">[</span><span class="n">orig_product_io</span><span class="p">][</span><span class="n">orig_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;chain totals&#39;</span><span class="p">][</span><span class="n">product</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;using </span><span class="si">{qty}</span><span class="s2"> of </span><span class="si">{product}</span><span class="s2"> from all units in </span><span class="si">{orig_chain.name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_unit</span> <span class="o">=</span> <span class="n">orig_chain</span><span class="o">.</span><span class="n">process_dict</span><span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_unit</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">remaining_product_dict</span><span class="p">[</span><span class="n">orig_product_io</span><span class="p">][</span><span class="n">orig_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">orig_unit</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span> <span class="c1">#check if some of the product has already been used for something</span>
                    <span class="n">qty</span> <span class="o">=</span> <span class="n">remaining_product_dict</span><span class="p">[</span><span class="n">orig_product_io</span><span class="p">][</span><span class="n">orig_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">orig_unit</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">product</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{product}</span><span class="s2"> found in remaining_product_dict, </span><span class="si">{qty}</span><span class="s2"> unused.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qty</span> <span class="o">=</span> <span class="n">io_dicts</span><span class="p">[</span><span class="n">orig_product_io</span><span class="p">][</span><span class="n">orig_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">orig_unit</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">product</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;using </span><span class="si">{qty}</span><span class="s2"> of </span><span class="si">{product}</span><span class="s2"> from </span><span class="si">{orig_unit.name}</span><span class="s2"> in </span><span class="si">{orig_chain.name}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">purge_fraction</span> <span class="ow">in</span> <span class="n">aux</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">purge_fraction</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">no_var</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">purge_fraction</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">purge_fraction</span><span class="p">]):</span>
                        <span class="n">calc</span><span class="o">.</span><span class="n">check_qty</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">purge_fraction</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">purge</span> <span class="o">=</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">purge_fraction</span><span class="p">]</span>
                        <span class="n">qty</span> <span class="o">=</span> <span class="n">qty</span> <span class="o">-</span> <span class="n">purge</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;purge: </span><span class="si">{purge}</span><span class="s2">, new qty: </span><span class="si">{qty}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">max_replace_fraction</span> <span class="ow">in</span> <span class="n">aux</span><span class="p">:</span> <span class="c1"># used for recycle flows only</span>
                <span class="k">if</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">max_replace_fraction</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">no_var</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">max_replace_fraction</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">max_replace_fraction</span><span class="p">]):</span>
                        <span class="n">calc</span><span class="o">.</span><span class="n">check_qty</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">max_replace_fraction</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">max_replace_fraction</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">max_replace_fraction</span><span class="p">]</span>
            
            <span class="c1"># process recycle connections</span>
            <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">replace</span> <span class="ow">in</span> <span class="n">aux</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">replace</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">replace</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">no_var</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">replace</span><span class="p">]</span> <span class="ow">in</span> <span class="n">unit</span><span class="o">.</span><span class="n">lookup_var_dict</span><span class="p">:</span>
                    <span class="n">replace_flow</span> <span class="o">=</span> <span class="n">dest_unit</span><span class="o">.</span><span class="n">var_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">scenario</span><span class="p">,</span> <span class="n">unit</span><span class="o">.</span><span class="n">lookup_var_dict</span><span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">replace</span><span class="p">]][</span><span class="s1">&#39;lookup_var&#39;</span><span class="p">]]</span> 
                    <span class="k">if</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">replace</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;fuel&#39;</span><span class="p">:</span>
                        <span class="n">replace_fuel</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">replace_flow</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">replace</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">replace_flow</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="n">dest_product_io</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{replace_flow}</span><span class="s2"> not found in </span><span class="si">{dest_chain.name}</span><span class="s2">&#39;s </span><span class="si">{dest_unit.name}</span><span class="s2"> </span><span class="si">{dest_product_io}</span><span class="s2">-flows&quot;</span><span class="p">)</span>

                <span class="n">r_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">original_inflows_dict</span><span class="o">=</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                                <span class="n">original_outflows_dict</span><span class="o">=</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                                <span class="n">recycled_qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span>
                                <span class="n">recycle_io</span><span class="o">=</span><span class="n">dest_product_io</span><span class="p">,</span>
                                <span class="n">recycled_flow</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
                                <span class="n">replaced_flow</span><span class="o">=</span><span class="n">replace_flow</span><span class="p">,</span>
                                <span class="n">max_replace_fraction</span><span class="o">=</span><span class="n">max_replace_fraction</span><span class="p">,</span>
                                <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;recycling </span><span class="si">{qty}</span><span class="s2"> of </span><span class="si">{product}</span><span class="s2"> from </span><span class="si">{orig_unit.name}</span><span class="s2"> in </span><span class="si">{orig_chain.name}</span><span class="s2"> to replace </span><span class="si">{replace_flow}</span><span class="s2"> in </span><span class="si">{dest_unit.name}</span><span class="s2"> in </span><span class="si">{dest_chain.name}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;original IO Dicts:&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;purge: </span><span class="si">{purge}</span><span class="s2">, max replace fraction: </span><span class="si">{max_replace_fraction}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;replaces fuel</span><span class="si">{replace_fuel}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">replace_fuel</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{product}</span><span class="s2"> replacing </span><span class="si">{replace_flow}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">energy_flows</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">product</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="ow">or</span> <span class="n">product</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;replacing fuel with energy&quot;</span><span class="p">)</span>
                            <span class="n">energy_replacing_fuel</span> <span class="o">=</span> <span class="kc">True</span> 
                            <span class="n">i_tmp</span><span class="p">,</span> <span class="n">o_tmp</span><span class="p">,</span> <span class="n">qty_remaining</span> <span class="o">=</span> <span class="n">dest_unit</span><span class="o">.</span><span class="n">recycle_energy_replacing_fuel</span><span class="p">(</span><span class="o">**</span><span class="n">r_kwargs</span><span class="p">)</span>  
                            <span class="k">break</span>

                <span class="k">if</span> <span class="n">energy_replacing_fuel</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">i_tmp</span><span class="p">,</span> <span class="n">o_tmp</span><span class="p">,</span> <span class="n">qty_remaining</span> <span class="o">=</span> <span class="n">dest_unit</span><span class="o">.</span><span class="n">recycle_1to1</span><span class="p">(</span><span class="o">**</span><span class="n">r_kwargs</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;sent </span><span class="si">{qty}</span><span class="s2"> of </span><span class="si">{product}</span><span class="s2"> from </span><span class="si">{orig_unit.name}</span><span class="s2"> in </span><span class="si">{orig_chain.name}</span><span class="s2"> to replace </span><span class="si">{replace_flow}</span><span class="s2"> in </span><span class="si">{dest_unit.name}</span><span class="s2"> in </span><span class="si">{dest_chain.name}</span><span class="s2"> &quot;</span><span class="p">)</span>
                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_tmp</span> 
                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">o_tmp</span> 
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;replaced IO Dicts:&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

                <span class="c1"># recalculate chain totals  </span>
                <span class="n">new_chain_totals</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                    <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="p">}</span>

                <span class="k">for</span> <span class="n">process</span><span class="p">,</span> <span class="n">inflows_dict</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">process</span> <span class="o">!=</span> <span class="s1">&#39;chain totals&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">inflow</span><span class="p">,</span> <span class="n">i_qty</span> <span class="ow">in</span> <span class="n">inflows_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">new_chain_totals</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">inflow</span><span class="p">]</span> <span class="o">+=</span> <span class="n">i_qty</span>
                <span class="k">for</span> <span class="n">process</span><span class="p">,</span> <span class="n">outflows_dict</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">process</span> <span class="o">!=</span> <span class="s1">&#39;chain totals&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">outflow</span><span class="p">,</span> <span class="n">o_qty</span> <span class="ow">in</span> <span class="n">outflows_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">new_chain_totals</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">outflow</span><span class="p">]</span> <span class="o">+=</span> <span class="n">o_qty</span>
                <span class="k">for</span> <span class="n">io_dict</span> <span class="ow">in</span> <span class="n">new_chain_totals</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">intermediate_product</span><span class="p">,</span> <span class="n">int_qty</span> <span class="ow">in</span> <span class="n">chain_intermediates_dict</span><span class="p">[</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">new_chain_totals</span><span class="p">[</span><span class="n">io_dict</span><span class="p">][</span><span class="n">intermediate_product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">int_qty</span>

                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;chain totals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;chain totals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;chain totals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_chain_totals</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span>
                <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;chain totals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_chain_totals</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]</span>
                <span class="n">remaining_product_dict</span><span class="p">[</span><span class="n">orig_product_io</span><span class="p">][</span><span class="n">orig_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">orig_unit</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">qty_remaining</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{remaining_product_dict[orig_product_io][orig_chain.name][orig_unit.name][product]}</span><span class="s2"> </span><span class="si">{product}</span><span class="s2"> remaining for </span><span class="si">{orig_chain.name}</span><span class="s2">-</span><span class="si">{orig_unit.name}</span><span class="s2">&quot;</span><span class="p">)</span>


            <span class="c1"># process non-reycle connection   </span>
            <span class="k">else</span><span class="p">:</span>         
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;sending </span><span class="si">{qty}</span><span class="s2"> of </span><span class="si">{product}</span><span class="s2"> to </span><span class="si">{dest_chain.name}</span><span class="s2"> as </span><span class="si">{dest_product_io}</span><span class="s2">-flow&quot;</span><span class="p">)</span>
                <span class="n">c_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span> 
                                <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span> 
                                <span class="n">i_o</span><span class="o">=</span><span class="n">dest_product_io</span><span class="p">,</span> 
                                <span class="n">unit_process</span> <span class="o">=</span> <span class="n">dest_unit_name</span><span class="p">,</span>
                                <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
                                <span class="p">)</span>
                <span class="p">(</span><span class="n">i_tmp</span><span class="p">,</span> 
                <span class="n">o_tmp</span><span class="p">,</span> 
                <span class="n">chain_intermediates_dict</span><span class="p">[</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                <span class="n">chain_internal_flows</span><span class="p">)</span> <span class="o">=</span> <span class="n">dest_chain</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="o">**</span><span class="n">c_kwargs</span><span class="p">)</span>
                <span class="n">internal_flows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chain_internal_flows</span><span class="p">)</span>
            
                <span class="c1"># add chain inflow/outflow data to factory inflow/outflow dictionaries</span>
                <span class="c1"># check if the chain already exists, and if so, aggregate the flow values instead of assigning/replacing</span>
                <span class="k">if</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="ow">and</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">process_dict</span> <span class="ow">in</span> <span class="n">i_tmp</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">substance</span><span class="p">,</span> <span class="n">i_qty</span> <span class="ow">in</span> <span class="n">i_tmp</span><span class="p">[</span><span class="n">process_dict</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">process_dict</span><span class="p">][</span><span class="n">substance</span><span class="p">]</span> <span class="o">+=</span> <span class="n">i_qty</span>
                    <span class="k">for</span> <span class="n">process_dict</span> <span class="ow">in</span> <span class="n">o_tmp</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">substance</span><span class="p">,</span> <span class="n">o_qty</span> <span class="ow">in</span> <span class="n">o_tmp</span><span class="p">[</span><span class="n">process_dict</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">process_dict</span><span class="p">][</span><span class="n">substance</span><span class="p">]</span> <span class="o">+=</span> <span class="n">o_qty</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_tmp</span>
                    <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">o_tmp</span> 
                
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{qty}</span><span class="s2"> of </span><span class="si">{product}</span><span class="s2"> as product from </span><span class="si">{orig_chain.name}</span><span class="s2"> (</span><span class="si">{orig_product_io}</span><span class="s2">) sent to to </span><span class="si">{dest_chain.name}</span><span class="s2"> (</span><span class="si">{dest_product_io}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="n">intermediate_product_dict</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">qty</span> <span class="o">-</span> <span class="n">qty_remaining</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{qty - qty_remaining} of </span><span class="si">{product}</span><span class="s2"> added to intermediate_product_dict&quot;</span><span class="p">)</span>

            <span class="n">orig_chain_name</span> <span class="o">=</span> <span class="n">orig_chain</span><span class="o">.</span><span class="n">name</span>
            <span class="n">dest_chain_name</span> <span class="o">=</span> <span class="n">dest_chain</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">orig_unit</span> <span class="ow">and</span> <span class="n">orig_unit</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">orig_unit_name</span> <span class="o">=</span> <span class="n">orig_unit</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="n">aux</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_unit</span><span class="p">]</span> <span class="o">==</span> <span class="n">dat</span><span class="o">.</span><span class="n">connect_all</span><span class="p">:</span>
                <span class="n">orig_unit_name</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_unit_name</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="k">if</span> <span class="n">dest_unit</span> <span class="ow">and</span> <span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">dest_unit_name</span> <span class="o">=</span> <span class="n">dest_unit</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="n">dest_product_io</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                <span class="n">dest_unit_name</span> <span class="o">=</span> <span class="n">dest_chain</span><span class="o">.</span><span class="n">process_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">dest_product_io</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
                <span class="n">dest_unit_name</span> <span class="o">=</span> <span class="n">dest_chain</span><span class="o">.</span><span class="n">process_names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dest_unit_name</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>

            <span class="k">if</span> <span class="n">dest_product_io</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span> <span class="ow">and</span> <span class="n">orig_product_io</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                <span class="n">orig_chain_name</span><span class="p">,</span> <span class="n">dest_chain_name</span> <span class="o">=</span> <span class="n">dest_chain_name</span><span class="p">,</span> <span class="n">orig_chain_name</span>
                <span class="n">orig_unit_name</span><span class="p">,</span> <span class="n">dest_unit_name</span> <span class="o">=</span> <span class="n">dest_unit_name</span><span class="p">,</span> <span class="n">orig_unit_name</span>

            <span class="n">internal_flows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">orig_chain_name</span><span class="p">,</span> <span class="n">orig_unit_name</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="p">(</span><span class="n">qty</span><span class="o">-</span><span class="n">qty_remaining</span><span class="p">),</span> <span class="n">dest_chain_name</span><span class="p">,</span> <span class="n">dest_unit_name</span><span class="p">])</span>
 

        <span class="n">factory_totals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">inflow</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">chain</span><span class="p">][</span><span class="s1">&#39;chain totals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">factory_totals</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">inflow</span><span class="p">]</span> <span class="o">+=</span> <span class="n">qty</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">outflow</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">chain</span><span class="p">][</span><span class="s1">&#39;chain totals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">factory_totals</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">outflow</span><span class="p">]</span> <span class="o">+=</span> <span class="n">qty</span>
        <span class="k">for</span> <span class="n">io_dict</span> <span class="ow">in</span> <span class="n">factory_totals</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">intermediate_product_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">factory_totals</span><span class="p">[</span><span class="n">io_dict</span><span class="p">][</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">qty</span> <span class="c1"># removes intermediate product quantities</span>

        <span class="k">if</span> <span class="n">write_to_xls</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="n">dat</span><span class="o">.</span><span class="n">outdir</span><span class="p">:</span>
                <span class="n">outdir</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{dat.outdir}</span><span class="s1">/</span><span class="si">{self.name}</span><span class="s1">&#39;</span>
                
            <span class="n">filename</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;f_</span><span class="si">{self.name}</span><span class="s1">_</span><span class="si">{scenario}</span><span class="s1">_{datetime.now().strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H%M&quot;)}&#39;</span>

            <span class="n">meta_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">metadata_df</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">user_data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> 
                          <span class="n">level</span><span class="o">=</span><span class="s2">&quot;Factory&quot;</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span> <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_product</span><span class="p">,</span>
                          <span class="n">product_qty</span><span class="o">=</span><span class="n">main_product_qty</span><span class="p">,</span> <span class="n">energy_flows</span><span class="o">=</span><span class="n">energy_flows</span><span class="p">)</span>

            <span class="n">totals_dict</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">nested_dicts</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">totals_dict</span><span class="p">[</span><span class="s1">&#39;factory inflows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">factory_totals</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span>
            <span class="n">totals_dict</span><span class="p">[</span><span class="s1">&#39;factory outflows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">factory_totals</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]</span>
            <span class="n">totals_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">totals_dict</span><span class="p">,</span> <span class="n">drop_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">totals_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">mass_energy_df</span><span class="p">(</span><span class="n">totals_df</span><span class="p">)</span>
            <span class="n">internal_flows_header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;origin chain&#39;</span><span class="p">,</span> <span class="s1">&#39;origin unit&#39;</span><span class="p">,</span> <span class="s1">&#39;flow product&#39;</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;destination chain&#39;</span><span class="p">,</span> <span class="s1">&#39;destination unit&#39;</span><span class="p">]</span>
            <span class="n">internal_flows_df</span> <span class="o">=</span> <span class="n">pan</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">internal_flows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">internal_flows_header</span><span class="p">)</span>

            <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_df</span><span class="p">,</span> <span class="n">totals_df</span><span class="p">,</span> <span class="n">internal_flows_df</span><span class="p">]</span>
            <span class="n">sheet_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.name}</span><span class="s1"> totals&#39;</span><span class="p">,</span> <span class="s1">&#39;internal flows&#39;</span><span class="p">]</span>

            <span class="n">all_inflows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
            <span class="n">all_outflows</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">process_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;chain totals&#39;</span><span class="p">]</span>
                <span class="n">chain_inflow_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">chain</span><span class="p">],</span> 
                                              <span class="n">col_order</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> 
                                              <span class="n">drop_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">chain_inflow_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">mass_energy_df</span><span class="p">(</span><span class="n">chain_inflow_df</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chain_inflow_df</span><span class="p">)</span>
                <span class="n">sheet_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="s2">&quot; inflows&quot;</span><span class="p">)</span>

                <span class="n">chain_outflow_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">chain</span><span class="p">],</span> 
                                               <span class="n">col_order</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                                               <span class="n">drop_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">chain_outflow_df</span><span class="p">)</span>
                <span class="n">chain_outflow_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">mass_energy_df</span><span class="p">(</span><span class="n">chain_outflow_df</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">chain_outflow_df</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chain_outflow_df</span><span class="p">)</span>
                <span class="n">sheet_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="s2">&quot; outflows&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">process_dict</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">chain</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;total&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">substance</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">chain</span><span class="p">][</span><span class="n">process_dict</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">all_inflows</span><span class="p">[</span><span class="n">process_dict</span><span class="p">][</span><span class="n">substance</span><span class="p">]</span> <span class="o">=</span> <span class="n">qty</span>
                        <span class="k">for</span> <span class="n">substance</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">io_dicts</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="n">chain</span><span class="p">][</span><span class="n">process_dict</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">all_outflows</span><span class="p">[</span><span class="n">process_dict</span><span class="p">][</span><span class="n">substance</span><span class="p">]</span> <span class="o">=</span> <span class="n">qty</span>

            <span class="n">all_outflows_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">all_outflows</span><span class="p">,</span> <span class="n">drop_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">all_outflows_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">mass_energy_df</span><span class="p">(</span><span class="n">all_outflows_df</span><span class="p">,</span> <span class="n">totals</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">all_outflows_df</span><span class="p">)</span>
            <span class="n">sheet_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;unit outflow matrix&quot;</span><span class="p">)</span>

            <span class="n">all_inflows_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">make_df</span><span class="p">(</span><span class="n">all_inflows</span><span class="p">,</span> <span class="n">drop_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">all_inflows_df</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">mass_energy_df</span><span class="p">(</span><span class="n">all_inflows_df</span><span class="p">,</span> <span class="n">totals</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">all_inflows_df</span><span class="p">)</span>
            <span class="n">sheet_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;unit inflow matrix&quot;</span><span class="p">)</span>

            <span class="n">iof</span><span class="o">.</span><span class="n">write_to_excel</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">sheet_list</span><span class="o">=</span><span class="n">sheet_list</span><span class="p">,</span> 
                               <span class="n">filedir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;successfully balanced factory on </span><span class="si">{main_product_qty}</span><span class="s2"> of </span><span class="si">{self.chain_dict[self.main_chain][&#39;product&#39;]}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">factory_totals</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">factory_totals</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Factory.diagram"><a class="viewcode-back" href="../factory.html#factory.Factory.diagram">[docs]</a>    <span class="k">def</span> <span class="nf">diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Outputs a diagram of the factory flows to file.</span>

<span class="sd">        Using Graphviz, takes the unit process names, sets of inflows and </span>
<span class="sd">        outflows, and the specified linkages of the factory to generate a</span>
<span class="sd">        diagram of the chain as a png and svg.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            outdir(str): The output directory where to write the files.</span>
<span class="sd">                (Defaults to the output directory specified in dataconfig in</span>
<span class="sd">                a &#39;pfd&#39; subfolder.)</span>

<span class="sd">            view(bool): If True, displays the diagram in the system</span>
<span class="sd">                viewer. </span>
<span class="sd">                (Defaults to True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="n">dat</span><span class="o">.</span><span class="n">outdir</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{outdir}</span><span class="s1">/</span><span class="si">{self.name}</span><span class="s1">/pfd_{datetime.now().strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H%M&quot;)}&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.name}</span><span class="s1">_{datetime.now().strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H%M&quot;)}&#39;</span>

        <span class="n">factory_diagram</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;factory&quot;</span><span class="p">)</span>
        <span class="n">factory_diagram</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">factory_diagrams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">io_diagram</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,)</span>
        <span class="n">io_diagram</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        

        <span class="c1"># gets product chains</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">:</span>
            <span class="n">d_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">view</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">outdir</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{outdir}</span><span class="s1">/</span><span class="si">{self.name}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">diagram_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">diagram</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diagram</span><span class="p">(</span><span class="o">**</span><span class="n">d_kwargs</span><span class="p">),</span>
                                <span class="n">process_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">process_list</span><span class="p">,</span> 
                                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">connect</span><span class="o">=</span><span class="p">[])</span>
            <span class="k">if</span> <span class="n">diagram_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_chain</span><span class="p">:</span>
                <span class="n">diagram_dict</span><span class="p">[</span><span class="s1">&#39;diagram&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
            <span class="n">factory_diagrams</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_dict</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">diagram_dict</span>

        <span class="c1"># connects chains on factory intermediate products</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">connect_product</span><span class="p">]</span>
            <span class="n">origin_chain</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_chain</span><span class="p">]</span>
<span class="c1">#            o_io = iof.clean_str(c[dat.origin_io][0])  # currently unused</span>
            <span class="n">d_io</span> <span class="o">=</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_io</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">d_io</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                <span class="n">dest_chain</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_chain</span><span class="p">]</span><span class="o">+</span><span class="n">factory_diagrams</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_chain</span><span class="p">]][</span><span class="s1">&#39;process_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;process&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="n">d_io</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
                <span class="n">dest_chain</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_chain</span><span class="p">]</span><span class="o">+</span><span class="n">factory_diagrams</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_chain</span><span class="p">]][</span><span class="s1">&#39;process_list&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;process&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

            
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_unit</span><span class="p">]</span> <span class="o">==</span> <span class="n">dat</span><span class="o">.</span><span class="n">connect_all</span><span class="p">:</span>
                <span class="n">origin_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_chain</span><span class="p">]</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> 
                <span class="n">p</span> <span class="ow">in</span> <span class="n">factory_diagrams</span><span class="p">[</span><span class="n">origin_chain</span><span class="p">][</span><span class="s1">&#39;process_list&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">origin_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_chain</span><span class="p">]</span><span class="o">+</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_unit</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">origin_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d_io</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                    <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">dest_chain</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">product</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">d_io</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
                    <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">dest_chain</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">product</span><span class="p">)</span>
                

        <span class="c1"># add inflows and outflows</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">factory_diagrams</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">factory_diagrams</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">diagram</span> <span class="o">=</span> <span class="n">factory_diagrams</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;diagram&#39;</span><span class="p">]</span>
            <span class="n">process_list</span> <span class="o">=</span> <span class="n">factory_diagrams</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;process_list&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">process_list</span><span class="p">):</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">unit</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">inflows</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">inflows</span><span class="p">)</span>
                <span class="n">outflows</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">outflows</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">dummy_index</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">chain</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_chain</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_unit</span><span class="p">]</span> <span class="ow">or</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_unit</span><span class="p">]</span> <span class="o">==</span> <span class="n">dat</span><span class="o">.</span><span class="n">connect_all</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_io</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                                <span class="n">inflows</span> <span class="o">=</span> <span class="n">inflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">connect_product</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">origin_io</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
                                <span class="n">outflows</span> <span class="o">=</span> <span class="n">outflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">connect_product</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        
                    <span class="k">if</span> <span class="n">chain</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_chain</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_io</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span> <span class="ow">and</span> <span class="n">unit</span> <span class="o">==</span> <span class="n">process_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">inflows</span> <span class="o">=</span> <span class="n">inflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">connect_product</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">iof</span><span class="o">.</span><span class="n">clean_str</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">dest_io</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span> <span class="ow">and</span> <span class="n">unit</span> <span class="o">==</span> <span class="n">process_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">outflows</span> <span class="o">=</span> <span class="n">outflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">connect_product</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">inflows</span><span class="p">:</span> <span class="n">inflows</span> <span class="o">=</span> <span class="n">inflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">outflows</span><span class="p">:</span> <span class="n">outflows</span> <span class="o">=</span> <span class="n">outflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inflows</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inflows</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                        <span class="n">io_diagram</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">inflows</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">inflows</span><span class="p">)</span>
                        <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">inflows</span><span class="p">,</span> <span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">process_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">outflows</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">outflows</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="n">io_diagram</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">outflows</span><span class="p">)</span>
                            <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="p">,</span> <span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">outflows</span> <span class="o">!=</span> <span class="n">unit</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]:</span>
                        <span class="n">outflows</span> <span class="o">=</span> <span class="n">outflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">outflows</span><span class="p">:</span> <span class="n">outflows</span> <span class="o">=</span> <span class="n">outflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">outflows</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">outflows</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="n">io_diagram</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">outflows</span><span class="p">)</span>
                            <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="p">,</span> <span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">)</span>


                <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">process_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inflows</span> <span class="o">!=</span> <span class="n">unit</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                        <span class="n">inflows</span> <span class="o">=</span> <span class="n">inflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">inflows</span><span class="p">:</span> <span class="n">inflows</span> <span class="o">=</span> <span class="n">inflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">inflows</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inflows</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="n">io_diagram</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">inflows</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">inflows</span><span class="p">)</span>
                            <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">inflows</span><span class="p">,</span> <span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">outflows</span> <span class="o">!=</span> <span class="n">unit</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]:</span>
                        <span class="n">outflows</span> <span class="o">=</span> <span class="n">outflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">outflows</span><span class="p">:</span> <span class="n">outflows</span> <span class="o">=</span> <span class="n">outflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">outflows</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">outflows</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="n">io_diagram</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">outflows</span><span class="p">)</span>
                            <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="p">,</span> <span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inflows</span> <span class="o">!=</span> <span class="n">unit</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                        <span class="n">inflows</span> <span class="o">=</span> <span class="n">inflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">inflows</span><span class="p">:</span> <span class="n">inflows</span> <span class="o">=</span> <span class="n">inflows</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">inflows</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inflows</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="n">io_diagram</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">inflows</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">inflows</span><span class="p">)</span>
                            <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">inflows</span><span class="p">,</span> <span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">outflows</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">outflows</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                        <span class="n">io_diagram</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">outflows</span><span class="p">)</span>
                        <span class="n">factory_diagram</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="p">,</span> <span class="n">chain</span><span class="o">+</span><span class="n">process</span><span class="o">+</span><span class="n">outflows</span><span class="p">)</span>


        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">diagram</span> <span class="ow">in</span> <span class="n">factory_diagrams</span><span class="p">:</span>
            <span class="n">factory_diagrams</span><span class="p">[</span><span class="n">diagram</span><span class="p">][</span><span class="s1">&#39;diagram&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">factory_diagram</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">factory_diagrams</span><span class="p">[</span><span class="n">diagram</span><span class="p">][</span><span class="s1">&#39;diagram&#39;</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">io_diagram</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">factory_diagram</span><span class="p">)</span>

        <span class="n">io_diagram</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;circo&#39;</span>
        
        <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">io_diagram</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>

        <span class="n">io_diagram</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="n">io_diagram</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;svg&#39;</span>
        <span class="n">io_diagram</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;created diagram for </span><span class="si">{self.name}</span><span class="s2"> factory&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, S.E. Tanzer

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>